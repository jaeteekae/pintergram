{% extends "base.html" %}
{% load staticfiles %}
{% block newsfeed-content %}

<!-- PUT IT BACK HERE -->
{% endblock %}




{% block new-post-mod %}



{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}


<!-- <div class="new-post pn"> -->
	<form enctype="multipart/form-data" id="post_form">
	
<!-- 	
		<div class="quarter" >
			<img class="crossed" id="img-preview-spot" src="{% static 'newsfeed/img/cross-blank.png' %}">
		</div> -->
		
		{% csrf_token %}
        <div class="quarter" >
			<input type="file" name="post-image" id="post-image" accept="image/*" >
        </div>
        <div class="threequarter all-inputs">
	    <input type="text" name="post_title" id="post_title" placeholder="Title your creation" class="new-post-input title"/>
	    <input type="text" name="post_text"  id="post_text"  placeholder="Caption" class="new-post-input text"/>
		<!-- <input type="text" name="tags"       id="tags"       placeholder="Tags (separate by commas)" class="new-post-input text"/>  -->
        <!-- tags separated by commas -->
		<button onclick="SubForm()" class="new-post-button">create post</button>
        </div>
		

	</form>
<!-- </div> -->
<!-- 
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>
<script src="{% static 'newsfeed/js/jquery.js' %}"></script> -->

<script type="text/javascript">

function SubForm (){
            $.ajax({
                url:'posts/',
                type:'post',
                enctype: "multipart/form-data",
                data:$('#post_form').serialize(),
                // success:function(){
                //     alert("worked");
                // }
            });
        }

var executeInt = true;
var wait = true;

setInterval(function(){
    if (executeInt) {
        doAjax();
        executeInt = false;
    }
    wait = true;
    doAjax();
}, 1000);

function doAjax() {
    $.ajax({ url: "posts", success: function(data) {
        var currentId = -1;
        if ($("#main-content-stream div").first().data("postid")) {
            currentId = $("#main-content-stream div").first().data("postid").id
        }
        // console.log("Current id: " + currentId);
        if (data) {
            for (var i = 0; i < data.length; i++) {
                var post = data[i];
                // console.log(post);
                if (Number(post["id"]) > Number(currentId)) {
                    // console.log(post["id"]);
                    // console.log("in addPostIndex with id = "+post["id"]);
                    addPostIndex(post);
                }
            }
        }

        wait = false;

        // doAjax();


        },
    cache: false, dataType: "json"});
}



function addPostIndex(data) {
    // console.log("in addPostIndex with id = "+data.id);
    if (data) {
        var stream = document.getElementById("main-content-stream");
        var recentChild = stream.firstChild;

        var newPost = document.createElement("div");
        newPost.className = "post pn";
        newPost.setAttribute("data-postid", '{"id":"'+data.id+'"}');
//////
        var credit = document.createElement("div");
        credit.className = "credit";


        var postAvatar = document.createElement("img");
        postAvatar.src = "{% static 'newsfeed/img/ui-danro.jpg' %}"
        postAvatar.className = "post-avatar";

        //TODO: CHANGE THIS WHEN USERNAMES ARE ACTUALLY A THING
        var username = document.createElement("div");
        //var usernameText = document.createTextNode(data.username);
        var usernameText = document.createTextNode(data.owner);
        username.appendChild(usernameText);
        username.className = "username monofur-font"

        var timestamp = document.createElement("div");
        var d = new Date(data.timestamp);
        var months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        var h = d.getHours();
        var day = d.getDate();
        var year = d.getFullYear();
        var mins = d.getMinutes();
        var a_p = " a.m."
        if (h > 12) {h = h - 12; a_p = " p.m.";}
        h = h.toString();
        day = day.toString();
        year = year.toString();
        mins = mins.toString();
        var fdate = months[d.getMonth()] + " " + day + ", " + year + ", " + h + ":" + mins + a_p;
        // var fdate = months[d.getMonth()] + " " + day + ", " + year + ", " + h ":" + mins + a_p;
        // console.log(fdate);
        var timestampText = document.createTextNode(fdate);
        timestamp.appendChild(timestampText);
        timestamp.className = "timestamp";

        credit.appendChild(postAvatar);
        credit.appendChild(username);
        credit.appendChild(timestamp);
        newPost.appendChild(credit);

//////

        var link = document.createElement("a");
        link.className = "post-link";
        
        if (data.image_path) {
            var img = document.createElement("img");
            img.className = "post-image";
            img.src = "/media/"+data.image_path;
            img.style.height = "100";
            img.style.width = "100";
            link.appendChild(img);

        }
        newPost.appendChild(link);

///////
        var title = document.createElement("div");
        title.className = "title monofur-font";
        var titleLink = document.createElement("a");
        titleLink.className = "post-link";
        
        var titleLinkText = document.createTextNode(data.post_title);
        titleLink.appendChild(titleLinkText);
        title.appendChild(titleLink);
        newPost.appendChild(title);

///////

        var caption = document.createElement("div");
        caption.className = "caption";
        var captionText = document.createTextNode(data.post_text);
        caption.appendChild(captionText);
        newPost.appendChild(caption);

/////
        var divider = document.createElement("div");
        divider.className = "divider";
        newPost.appendChild(divider);

//////
        var upvotes = document.createElement("div");
        upvotes.className = "upvotes";
        if (data.tags) {

        }
        var upvotesText = document.createTextNode("10,000 upvotes      ");
        upvotes.appendChild(upvotesText);

        var upvoteButton = document.createElement("div");
        upvoteButton.className = "upvote-button";

        var upvoteButtonText = document.createTextNode("\u2606");
        upvoteButton.appendChild(upvoteButtonText);
        upvotes.appendChild(upvoteButton);
        newPost.appendChild(upvotes);

        // newPost.insertBefore(recentChild, newPost);
        // recentChild.insertBefore(newPost, null);
        // console.log(recentChild);

        stream.insertBefore(newPost, recentChild);

    }

}

// $(document).ready(function() {
    document.getElementById("current_user").innerText = "Currently logged in as: {{ self_un }}";
    // var header_username = docment.getElementById(current_user);
    // header_username.innerHtml
    // console.log("here");
    // $("#current_user").html = {{ test_user }};
// });

</script>

{% endblock %}